// --- Ð†ÐœÐŸÐžÐ Ð¢Ð˜ Ð‘Ð†Ð‘Ð›Ð†ÐžÐ¢Ð•Ðš ---
const { Telegraf, Markup } = require('telegraf');
const express = require('express');
const cors = require('cors');

// --- ÐŸÐ•Ð Ð•Ð’Ð†Ð ÐšÐ Ð¢ÐžÐšÐ•ÐÐ ---
if (!process.env.BOT_TOKEN) {
  console.error('âŒ ÐŸÐžÐœÐ˜Ð›ÐšÐ: Ð’Ñ–Ð´ÑÑƒÑ‚Ð½Ñ–Ð¹ BOT_TOKEN Ð² Ð·Ð¼Ñ–Ð½Ð½Ð¸Ñ… ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ð°!');
  process.exit(1);
}

console.log('âœ… BOT_TOKEN Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾');

// --- Ð†ÐÐ†Ð¦Ð†ÐÐ›Ð†Ð—ÐÐ¦Ð†Ð¯ ---
const bot = new Telegraf(process.env.BOT_TOKEN);
const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors()); // Ð”Ð¾Ð·Ð²Ð¾Ð»ÑÑ”Ð¼Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚Ð¸ Ð· Ñ‚Ð²Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ñƒ Ð½Ð° Vercel
app.use(express.json()); // Ð’Ñ‡Ð¸Ð¼Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ñ‚Ð¸ JSON Ð´Ð°Ð½Ñ–

// --- Ð›ÐžÐ“Ð†ÐšÐ Ð‘ÐžÐ¢Ð ---
bot.start((ctx) => {
  ctx.reply('ÐŸÑ€Ð¸Ð²Ñ–Ñ‚! Ð¯ SaveMedia Ð‘Ð¾Ñ‚. ðŸš€\n\nÐ©Ð¾Ð± ÑÐºÐ°Ñ‡Ð°Ñ‚Ð¸ Ð²Ñ–Ð´ÐµÐ¾, Ð½Ð°Ñ‚Ð¸ÑÐ½Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ "Ð¡ÐºÐ°Ñ‡Ð°Ñ‚Ð¸ Ð’Ñ–Ð´ÐµÐ¾ ðŸš€" Ð²Ð½Ð¸Ð·Ñƒ.');
});

bot.help((ctx) => ctx.reply('ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ñ‚Ð¸ÑÐ½Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¼ÐµÐ½ÑŽ Ð·Ð»Ñ–Ð²Ð°, Ð²ÑÑ‚Ð°Ð² Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð½Ð° TikTok/Instagram, Ñ– Ñ ÑÐºÐ°Ñ‡Ð°ÑŽ Ð²Ñ–Ð´ÐµÐ¾.'));


// --- Ð›ÐžÐ“Ð†ÐšÐ Ð¡Ð•Ð Ð’Ð•Ð Ð (API) ---

// Ð“Ð¾Ð»Ð¾Ð²Ð½Ð¸Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ - ÑÑŽÐ´Ð¸ ÑÑ‚ÑƒÐºÐ°Ñ”Ñ‚ÑŒÑÑ React-Ð´Ð¾Ð´Ð°Ñ‚Ð¾Ðº Ð· ÐºÐ½Ð¾Ð¿ÐºÐ¾ÑŽ "Ð¡ÐºÐ°Ñ‡Ð°Ñ‚Ð¸"
app.post('/download', async (req, res) => {
  const { url, chatId } = req.body;

  console.log(`ðŸ“¥ ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚ Ð½Ð° ÑÐºÐ°Ñ‡ÑƒÐ²Ð°Ð½Ð½Ñ: ${url} Ð´Ð»Ñ ÑŽÐ·ÐµÑ€Ð° ${chatId}`);

  // Ð‘Ð°Ð·Ð¾Ð²Ð° Ð²Ð°Ð»Ñ–Ð´Ð°Ñ†Ñ–Ñ
  if (!url || !chatId) {
    return res.status(400).json({ success: false, message: 'ÐÐµÐ¼Ð°Ñ” Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð°Ð±Ð¾ ID Ñ‡Ð°Ñ‚Ñƒ' });
  }

  try {
    // 1. ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÑÑ”Ð¼Ð¾ ÑŽÐ·ÐµÑ€Ñƒ Ð² Ñ‡Ð°Ñ‚, Ñ‰Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑ Ð¿Ñ–ÑˆÐ¾Ð²
    await bot.telegram.sendMessage(chatId, 'ðŸ” Ð¨ÑƒÐºÐ°ÑŽ Ð²Ñ–Ð´ÐµÐ¾, Ð·Ð°Ñ‡ÐµÐºÐ°Ð¹Ñ‚Ðµ ÑÐµÐºÑƒÐ½Ð´Ð¾Ñ‡ÐºÑƒ...');

    // 2. Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ TikWM API (Ð±ÐµÐ·ÐºÐ¾ÑˆÑ‚Ð¾Ð²Ð½Ð¸Ð¹, Ð±ÐµÐ· ÐºÐ»ÑŽÑ‡Ñ–Ð²)
    const apiUrl = `https://www.tikwm.com/api/?url=${encodeURIComponent(url)}&hd=1`;
    
    const response = await fetch(apiUrl);
    const result = await response.json();
    
    console.log('âœ… Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²Ñ–Ð´ TikWM:', result);

    // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾, Ñ‡Ð¸ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð¹ÑˆÐ»Ð¾
    if (result.code !== 0 || !result.data) {
      throw new Error('ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð·Ð½Ð°Ð¹Ñ‚Ð¸ Ð²Ñ–Ð´ÐµÐ¾ Ð·Ð° Ñ†Ð¸Ð¼ Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½ÑÐ¼. ÐœÐ¾Ð¶Ð»Ð¸Ð²Ð¾, Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ Ð·Ð°ÐºÑ€Ð¸Ñ‚Ð¸Ð¹ Ð°Ð±Ð¾ Ð²Ñ–Ð´ÐµÐ¾ Ð²Ð¸Ð´Ð°Ð»ÐµÐ½Ð¾.');
    }
    
    // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿Ñ€ÑÐ¼Ðµ Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð½Ð° Ð²Ñ–Ð´ÐµÐ¾ (HD ÑÐºÑ‰Ð¾ Ñ”, Ñ–Ð½Ð°ÐºÑˆÐµ Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ðµ)
    const videoUrl = result.data.hdplay || result.data.play;
    
    if (!videoUrl) {
      throw new Error('ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð¿Ñ€ÑÐ¼Ðµ Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð½Ð° Ð²Ñ–Ð´ÐµÐ¾');
    }
    
    console.log(`ðŸ“¹ ÐŸÑ€ÑÐ¼Ðµ Ð¿Ð¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ð½Ð° Ð²Ñ–Ð´ÐµÐ¾ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾!`);
    
    // 3. Ð’Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÑÑ”Ð¼Ð¾ Ð²Ñ–Ð´ÐµÐ¾ Ð² Ð¢ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼
    await bot.telegram.sendVideo(chatId, videoUrl, {
        caption: 'Ð’Ñ–Ð´ÐµÐ¾ ÑÐºÐ°Ñ‡Ð°Ð½Ð¾ Ð±ÐµÐ· Ð²Ð¾Ð´ÑÐ½Ð¾Ð³Ð¾ Ð·Ð½Ð°ÐºÐ°! ðŸš€\nÐ—Ð° Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð¾ÑŽ @SaveMedia_bot'
    });

    console.log(`ðŸ“¤ Ð’Ñ–Ð´ÐµÐ¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ ÑŽÐ·ÐµÑ€Ñƒ ${chatId}`);
    
    // 4. Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ”Ð¼Ð¾ Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ñƒ, Ñ‰Ð¾ Ð²ÑÐµ Ð´Ð¾Ð±Ñ€Ðµ (Ñ‰Ð¾Ð± Ð·Ð°ÐºÑ€Ð¸Ñ‚Ð¸ Ð²Ñ–ÐºÐ½Ð¾)
    res.json({ success: true });

  } catch (error) {
    console.error('âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ–Ð´ Ñ‡Ð°Ñ ÑÐºÐ°Ñ‡ÑƒÐ²Ð°Ð½Ð½Ñ:', error.message);
    
    // ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÑÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ð² Ñ‡Ð°Ñ‚ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñƒ
    try {
        await bot.telegram.sendMessage(chatId, `âš ï¸ Ð’Ð¸Ð±Ð°Ñ‡Ñ‚Ðµ, ÑÑ‚Ð°Ð»Ð°ÑÑ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°: ${error.message}`);
    } catch (telegramError) {
        console.error('ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ð¸ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ð² Ð¢ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼:', telegramError.message);
    }
    
    // ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÑÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ð½Ð° Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´
    res.status(500).json({ success: false, message: error.message });
  }
});


// ÐŸÑ€Ð¾ÑÑ‚Ð° Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°, Ñ‡Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ð¶Ð¸Ð²Ð¸Ð¹ (Ð´Ð»Ñ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð°)
app.get('/', (_, res) => res.send('Ð¡ÐµÑ€Ð²ÐµÑ€ SaveMedia Ð¿Ñ€Ð°Ñ†ÑŽÑ” Ñ– Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ð¹ ÐºÐ°Ñ‡Ð°Ñ‚Ð¸! ðŸ¤–'));

// --- Ð—ÐÐŸÐ£Ð¡Ðš ---

// ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÑƒ
process.on('uncaughtException', (error) => {
  console.error('âŒ ÐÐµÐ¾Ð±Ñ€Ð¾Ð±Ð»ÐµÐ½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°:', error);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('âŒ ÐÐµÐ¾Ð±Ñ€Ð¾Ð±Ð»ÐµÐ½Ðµ Ð²Ñ–Ð´Ñ…Ð¸Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾Ð¼Ñ–ÑÑƒ:', reason);
  process.exit(1);
});

// Ð¡Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ ÑÐµÑ€Ð²ÐµÑ€ API
app.listen(PORT, () => {
    console.log(`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ API Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¸Ð¹ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñ– ${PORT}`);
});

// ÐŸÐ¾Ñ‚Ñ–Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ð±Ð¾Ñ‚Ð°
bot.launch()
  .then(() => {
    console.log('âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¸Ð¹ Ð² Ð¢ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ñ–!');
  })
  .catch((error) => {
    console.error('âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÑƒ Ð±Ð¾Ñ‚Ð°:', error);
    process.exit(1);
  });

// Ð§ÐµÐ¼Ð½Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ Ñ€Ð¾Ð±Ð¾Ñ‚Ð¸
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));