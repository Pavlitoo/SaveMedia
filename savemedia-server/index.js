// 1. –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ "—Å–µ–π—Ñ" –¥–ª—è —Ç–æ–∫–µ–Ω–∞
require('dotenv').config();

// 2. –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –≥–æ–ª–æ–≤–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏
const express = require('express'); // –°–µ—Ä–≤–µ—Ä –¥–ª—è Web App
const cors = require('cors'); // –î–æ–∑–≤—ñ–ª –Ω–∞ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è —Å–∞–π—Ç—ñ–≤
const { Telegraf, Markup } = require('telegraf'); // –ì–æ–ª–æ–≤–Ω–∏–π –º–æ–∑–æ–∫ –±–æ—Ç–∞

// –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —Ç–æ–∫–µ–Ω
if (!process.env.BOT_TOKEN) {
  console.error('‚ùå –ü–û–ú–ò–õ–ö–ê: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É —Ñ–∞–π–ª—ñ .env!');
  process.exit(1);
}

// 3. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –±–æ—Ç–∞ —ñ —Å–µ—Ä–≤–µ—Ä
const bot = new Telegraf(process.env.BOT_TOKEN);
const app = express();
const PORT = process.env.PORT || 3000; // –ü–æ—Ä—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è Render)

// --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ë–û–¢–ê (Telegraf) ---

// –©–æ —Ä–æ–±–∏—Ç–∏, –∫–æ–ª–∏ –Ω–∞—Ç–∏—Å–∫–∞—é—Ç—å /start
bot.start((ctx) => {
  ctx.reply(
    '–ü—Ä–∏–≤—ñ—Ç! –Ø SaveMedia –ë–æ—Ç. üöÄ\n\n–©–æ–± —Å–∫–∞—á–∞—Ç–∏ –≤—ñ–¥–µ–æ, –Ω–∞—Ç–∏—Å–Ω–∏ —Å–∏–Ω—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –∑–ª—ñ–≤–∞ üëá',
    // –¶–µ–π –∫–æ–¥ –¥—É–±–ª—é—î –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –ø—Ä—è–º–æ –≤ —á–∞—Ç –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ (–Ω–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ, –∞–ª–µ –∫—Ä—É—Ç–æ)
    Markup.keyboard([
      Markup.button.webApp('–í—ñ–¥–∫—Ä–∏—Ç–∏ –î–æ–¥–∞—Ç–æ–∫ üì±', 'https://save-media-fog3.vercel.app/') // <-- –í–ê–ñ–õ–ò–í–û: –í–°–¢–ê–í –°–Æ–î–ò –°–í–û–Ñ –ü–û–°–ò–õ–ê–ù–ù–Ø –ó VERCEL!
    ]).resize()
  );
});

// –ü—Ä–æ—Å—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ø–æ–º–æ–≥–∏
bot.help((ctx) => ctx.reply('–ü—Ä–æ—Å—Ç–æ –≤—ñ–¥–∫—Ä–∏–π –¥–æ–¥–∞—Ç–æ–∫ —á–µ—Ä–µ–∑ –º–µ–Ω—é —ñ –≤—Å—Ç–∞–≤ –ø–æ—Å–∏–ª–∞–Ω–Ω—è. –Ø –≤—Å–µ –∑—Ä–æ–±–ª—é –∑–∞ —Ç–µ–±–µ!'));

// –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–æ—Ç–∞ (–≤—ñ–Ω –ø–æ—á–∏–Ω–∞—î —Å–ª—É—Ö–∞—Ç–∏ –¢–µ–ª–µ–≥—Ä–∞–º)
bot.launch().then(() => {
    console.log('‚úÖ –ë–æ—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∏–π –≤ –¢–µ–ª–µ–≥—Ä–∞–º—ñ!');
});


// --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–ï–†–í–ï–†–ê (Express) ---
// –¶–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± —Ç–≤—ñ–π React –¥–æ–¥–∞—Ç–æ–∫ –º—ñ–≥ —Å—é–¥–∏ —Å—Ç—É–∫–∞—Ç–∏—Å—å

app.use(cors()); // –î–æ–∑–≤–æ–ª—è—î–º–æ –∑–∞–ø–∏—Ç–∏ –∑ —ñ–Ω—à–∏—Ö —Å–∞–π—Ç—ñ–≤
app.use(express.json()); // –í—á–∏–º–æ —Å–µ—Ä–≤–µ—Ä —Ä–æ–∑—É–º—ñ—Ç–∏ JSON

// –ü—Ä–æ—Å—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ —Å–µ—Ä–≤–µ—Ä –∂–∏–≤–∏–π (–≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ)
app.get('/', (req, res) => {
  res.send('–°–µ—Ä–≤–µ—Ä SaveMedia –ø—Ä–∞—Ü—é—î! ü§ñ');
});

// –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä
app.listen(PORT, () => {
  console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—ñ ${PORT}`);
});

// --- –ß–µ–º–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏ (—â–æ–± –Ω–µ –≤–∏—Å—ñ–≤ —É –ø–∞–º'—è—Ç—ñ) ---
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));